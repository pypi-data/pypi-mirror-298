"use strict";(self.webpackChunk_jupytergis_jupytergis_core=self.webpackChunk_jupytergis_jupytergis_core||[]).push([[557],{92557:(e,t,r)=>{r.r(t),r.d(t,{IJGISExternalCommandRegistryToken:()=>g,IJGISFormSchemaRegistryToken:()=>c,IJGISLayerBrowserRegistryToken:()=>f,IJupyterGISDocTracker:()=>p,JupyterGISDoc:()=>d,JupyterGISModel:()=>u});var s=r(81473),i=r(74602),a=r(26803),n=r.n(a),o=r(22697),h=r(67262);class d extends o.YDocument{constructor(){super(),this.editable=!0,this._optionsObserver=e=>{this._optionsChanged.emit(e.keys)},this._optionsChanged=new i.Signal(this),this._layersChanged=new i.Signal(this),this._layerTreeChanged=new i.Signal(this),this._sourcesChanged=new i.Signal(this),this._terrainChanged=new i.Signal(this),this._options=this.ydoc.getMap("options"),this._layers=this.ydoc.getMap("layers"),this._layerTree=this.ydoc.getArray("layerTree"),this._sources=this.ydoc.getMap("sources"),this._terrain=this.ydoc.getMap("terrain"),this.undoManager.addToScope(this._layers),this.undoManager.addToScope(this._sources),this.undoManager.addToScope(this._layerTree),this._layers.observeDeep(this._layersObserver.bind(this)),this._layerTree.observe(this._layerTreeObserver.bind(this)),this._sources.observeDeep(this._sourcesObserver.bind(this)),this._terrain.observe(this._terrainObserver.bind(this)),this._options.observe(this._optionsObserver.bind(this))}dispose(){super.dispose()}get version(){return"0.1.0"}get layers(){return h.JSONExt.deepCopy(this._layers.toJSON())}set layers(e){this.transact((()=>{for(const[t,r]of Object.entries(e))this._layers.set(t,r)}))}set sources(e){this.transact((()=>{for(const[t,r]of Object.entries(e))this._sources.set(t,r)}))}get sources(){return h.JSONExt.deepCopy(this._sources.toJSON())}get layerTree(){return h.JSONExt.deepCopy(this._layerTree.toJSON())}set layerTree(e){this.transact((()=>{this._layerTree.delete(0,this._layerTree.length),this._layerTree.push(e)}))}get terrain(){return h.JSONExt.deepCopy(this._terrain.toJSON())}set terrain(e){this.transact((()=>{for(const[t,r]of Object.entries(e))this._terrain.set(t,r)}))}getLayer(e){if(this._layers.has(e))return h.JSONExt.deepCopy(this._layers.get(e))}getSource(e){if(this._sources.has(e))return h.JSONExt.deepCopy(this._sources.get(e))}set options(e){this.transact((()=>{for(const[t,r]of Object.entries(e))this._options.set(t,r)}))}get options(){return h.JSONExt.deepCopy(this._options.toJSON())}get layersChanged(){return this._layersChanged}get layerTreeChanged(){return this._layerTreeChanged}get sourcesChanged(){return this._sourcesChanged}get optionsChanged(){return this._optionsChanged}get terrainChanged(){return this._terrainChanged}layerExists(e){return Boolean(this._getLayerAsYMap(e))}removeLayer(e){this.transact((()=>{this._layers.delete(e)}))}addLayer(e,t){this.transact((()=>{this._layers.set(e,t)}))}updateLayer(e,t){this.transact((()=>{this._layers.set(e,t)}))}addLayerTreeItem(e,t){this.transact((()=>{this._layerTree.insert(e,[t])}))}updateLayerTreeItem(e,t){this.transact((()=>{this._layerTree.delete(e),t&&this._layerTree.insert(e,[t])}))}getObject(e){const t=this.getLayer(e);if(t)return t;return this.getSource(e)||void 0}updateObjectParameters(e,t){const r=this.getLayer(e);r&&(r.parameters=Object.assign(Object.assign({},r.parameters),t),this.updateLayer(e,r));const s=this.getSource(e);s&&(s.parameters=Object.assign(Object.assign({},s.parameters),t),this.updateSource(e,s))}sourceExists(e){return Boolean(this._getSourceAsYMap(e))}removeSource(e){this.transact((()=>{this._sources.delete(e)}))}addSource(e,t){this.transact((()=>{this._sources.set(e,t)}))}updateSource(e,t){this.transact((()=>this._sources.set(e,t)))}getOption(e){const t=this._options.get(e);if(t)return h.JSONExt.deepCopy(t)}setOption(e,t){this.transact((()=>{this._options.set(e,t)}))}static create(){return new d}_getLayerAsYMap(e){if(this._layers.has(e))return this._layers.get(e)}_getSourceAsYMap(e){if(this._sources.has(e))return this._sources.get(e)}_layersObserver(e){const t=[];let r=!1;e.forEach((e=>{e.keys.forEach(((s,i)=>{r||(r=!0),t.push({id:i,newValue:h.JSONExt.deepCopy(e.target.toJSON()[i])})}))})),r=0===t.length||r,r&&this._layersChanged.emit({layerChange:t})}_layerTreeObserver(e){const t=e.delta;this._layerTreeChanged.emit({layerTreeChange:t})}_sourcesObserver(e){const t=[];let r=!1;e.forEach((e=>{e.keys.forEach(((s,i)=>{r||(r=!0),t.push({id:i,newValue:h.JSONExt.deepCopy(e.target.toJSON()[i])})}))})),r=0===t.length||r,r&&this._sourcesChanged.emit({sourceChange:t})}_terrainObserver(e){this._terrainChanged.emit(this.terrain)}}const l=JSON.parse('{"type":"object","title":"IJGISContent","required":["layers","sources"],"additionalProperties":false,"properties":{"layers":{"$ref":"#/definitions/jGISLayers"},"sources":{"$ref":"#/definitions/jGISSources"},"layerTree":{"$ref":"#/definitions/jGISLayerTree"},"terrain":{"$ref":"#/definitions/jGISTerrain"},"options":{"$ref":"#/definitions/jGISOptions"}},"definitions":{"layerType":{"type":"string","enum":["RasterLayer","VectorLayer","VectorTileLayer","HillshadeLayer","WebGlLayer","ImageLayer"]},"sourceType":{"type":"string","enum":["RasterSource","VectorTileSource","GeoJSONSource","RasterDemSource","VideoSource","ImageSource","ShapefileSource","GeoTiffSource"]},"jGISLayer":{"title":"IJGISLayer","type":"object","additionalProperties":false,"required":["name","type","visible"],"properties":{"name":{"type":"string"},"type":{"$ref":"#/definitions/layerType"},"visible":{"type":"boolean","default":true},"parameters":{"type":"object"},"filters":{"$ref":"#/definitions/jGISFilter"}}},"jGISSource":{"title":"IJGISSource","type":"object","additionalProperties":false,"required":["name","type"],"properties":{"name":{"type":"string"},"type":{"$ref":"#/definitions/sourceType"},"parameters":{"type":"object"}}},"jGISLayerGroup":{"title":"IJGISLayerGroup","type":"object","additionalProperties":false,"required":["name","layers"],"properties":{"name":{"type":"string"},"layers":{"type":"array","default":[],"items":{"$ref":"#/definitions/jGISLayerItem"}},"visible":{"type":"boolean","default":true},"parameters":{"type":"object"}}},"jGISLayerItem":{"title":"IJGISLayerItem","oneOf":[{"type":"string"},{"$ref":"#/definitions/jGISLayerGroup"}]},"jGISLayers":{"title":"IJGISLayers","type":"object","default":{},"additionalProperties":{"$ref":"#/definitions/jGISLayer"}},"jGISSources":{"title":"IJGISSources","type":"object","default":{},"additionalProperties":{"$ref":"#/definitions/jGISSource"}},"jGISLayerTree":{"title":"IJGISLayerTree","type":"array","default":[],"items":{"$ref":"#/definitions/jGISLayerItem"}},"jGISTerrain":{"title":"IJGISTerrain","type":"object","default":{},"required":["source","exaggeration"],"additionalProperties":false,"properties":{"source":{"type":"string","description":"The id of the DEM source","default":""},"exaggeration":{"type":"number","default":1}}},"jGISOptions":{"title":"IJGISOptions","type":"object","default":{},"required":[],"additionalProperties":false,"properties":{"latitude":{"type":"number","default":0},"longitude":{"type":"number","default":0},"zoom":{"type":"number","default":0},"bearing":{"type":"number","default":0},"pitch":{"type":"number","default":0},"extent":{"type":"array","default":null,"items":{"type":"number"}},"projection":{"type":"string","default":"EPSG:3857"}}},"jGISFilterItem":{"title":"IJGISFilterItem","type":"object","default":{},"required":["operator","feature","value"],"additionalProperties":false,"properties":{"operator":{"type":"string","enum":["==","!=",">","<",">=","<="],"default":"=="},"feature":{"type":"string","default":""},"value":{"type":["string","number"]}}},"jGISFilter":{"title":"IJGISFilter","type":"object","required":["logicalOp","appliedFilters"],"additionalProperties":false,"properties":{"logicalOp":{"type":"string","default":"all"},"appliedFilters":{"type":"array","default":[],"items":{"$ref":"#/definitions/jGISFilterItem"}}}}}}');class u{constructor(e){this._onSharedModelChanged=(e,t)=>{var r;t&&(null===(r=null==t?void 0:t.objectChange)||void 0===r?void 0:r.length)&&(this._contentChanged.emit(void 0),this.dirty=!0)},this.collaborative=!0,this._onClientStateChanged=e=>{const t=this.sharedModel.awareness.getStates();this._clientStateChanged.emit(t),this._sharedModel.awareness.on("change",(e=>{(e.added.length||e.removed.length)&&this._userChanged.emit(this.users)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._dirty=!1,this._readOnly=!1,this._isDisposed=!1,this._userChanged=new i.Signal(this),this._disposed=new i.Signal(this),this._contentChanged=new i.Signal(this),this._stateChanged=new i.Signal(this),this._themeChanged=new i.Signal(this),this._clientStateChanged=new i.Signal(this);const{sharedModel:t}=e;t?this._sharedModel=t:(this._sharedModel=d.create(),this._sharedModel.changed.connect(this._onSharedModelChanged)),this.sharedModel.awareness.on("change",this._onClientStateChanged)}get sharedModel(){return this._sharedModel}get isDisposed(){return this._isDisposed}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get themeChanged(){return this._themeChanged}get currentUserId(){var e;return null===(e=this.sharedModel)||void 0===e?void 0:e.awareness.clientID}get users(){var e;this._usersMap=null===(e=this._sharedModel)||void 0===e?void 0:e.awareness.getStates();const t=[];return this._usersMap&&this._usersMap.forEach(((e,r)=>{t.push({userId:r,userData:e.user})})),t}get userChanged(){return this._userChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get localState(){return this.sharedModel.awareness.getLocalState()}get clientStateChanged(){return this._clientStateChanged}get sharedOptionsChanged(){return this.sharedModel.optionsChanged}get sharedLayersChanged(){return this.sharedModel.layersChanged}get sharedLayerTreeChanged(){return this.sharedModel.layerTreeChanged}get sharedSourcesChanged(){return this.sharedModel.sourcesChanged}get terrainChanged(){return this.sharedModel.terrainChanged}get disposed(){return this._disposed}dispose(){this._isDisposed||(this._isDisposed=!0,this._sharedModel.dispose(),this._disposed.emit(),i.Signal.clearData(this))}toString(){return JSON.stringify(this.getContent(),null,2)}fromString(e){const t=JSON.parse(e),r=(new(n())).compile(l);if(!r(t)){let e="File format errors:\n";for(const t of r.errors||[])e=`${e}- ${t.instancePath} ${t.message}\n`;throw Error(e)}this.sharedModel.transact((()=>{var e,r,s,i,a;this.sharedModel.sources=null!==(e=t.sources)&&void 0!==e?e:{},this.sharedModel.layers=null!==(r=t.layers)&&void 0!==r?r:{},this.sharedModel.layerTree=null!==(s=t.layerTree)&&void 0!==s?s:[],this.sharedModel.terrain=null!==(i=t.terrain)&&void 0!==i?i:{source:"",exaggeration:0},this.sharedModel.options=null!==(a=t.options)&&void 0!==a?a:{latitude:0,longitude:0,zoom:0,bearing:0,pitch:0,projection:"EPSG:3857"}})),this.dirty=!0}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}initialize(){}getWorker(){return u.worker}getContent(){return{sources:this.sharedModel.sources,layers:this.sharedModel.layers,layerTree:this.sharedModel.layerTree,options:this.sharedModel.options,terrain:this.sharedModel.terrain}}setDrive(e,t){this._drive=e,this._filePath=t}getLayers(){return this.sharedModel.layers}getSources(){return this.sharedModel.sources}getLayerTree(){return this.sharedModel.layerTree}getLayer(e){return this.sharedModel.getLayer(e)}getSource(e){return this.sharedModel.getSource(e)}getSourcesByType(e){const t={};for(const r of Object.keys(this.getSources()||{})){const s=this.getSource(r);(null==s?void 0:s.type)===e&&(t[r]=s.name)}return t}getLayersBySource(e){const t=[];return Object.entries(this.getLayers()||{}).forEach((([r,s])=>{var i;(null===(i=s.parameters)||void 0===i?void 0:i.source)===e&&t.push(r)})),t}async readGeoJSON(e){if(!this._drive)return;let t=s.PathExt.dirname(this._filePath);t.includes(":")&&(t=t.split(":")[1]);const r=s.PathExt.join(t,e);return this._drive.get(r).then((e=>JSON.parse(e.content))).catch((e=>{throw e}))}addGroup(e,t,r){if(y.findItemPath(this.getLayerTree(),e).length)return void console.warn(`The group "${t}" already exist in the layer tree`);const s={name:e,layers:[]};this._addLayerTreeItem(s,t,r)}addLayer(e,t,r,s){this.getLayer(e)||this.sharedModel.addLayer(e,t),this._addLayerTreeItem(e,r,s)}removeLayer(e){this._removeLayerTreeLayer(this.getLayerTree(),e),this.sharedModel.removeLayer(e)}setTerrain(e){this._sharedModel.terrain=e}setOptions(e){this._sharedModel.options=e}getOptions(){return this._sharedModel.options}syncSelected(e,t){this.sharedModel.awareness.setLocalStateField("selected",{value:e,emitter:t})}setUserToFollow(e){this._sharedModel&&this._sharedModel.awareness.setLocalStateField("remoteUser",e)}getClientId(){return this.sharedModel.awareness.clientID}_addLayerTreeItem(e,t,r){if(t){const s=this._getLayerTreeInfo(t);s&&(s.workingGroup.layers.splice(null!=r?r:s.workingGroup.layers.length,0,e),this._sharedModel.updateLayerTreeItem(s.mainGroupIndex,s.mainGroup))}else this.sharedModel.addLayerTreeItem(null!=r?r:this.getLayerTree().length,e)}moveItemsToGroup(e,t,r){const s=this.getLayerTree();for(const i of e)if(this.getLayer(i))this._removeLayerTreeLayer(s,i),this._addLayerTreeItem(i,t,r);else{const e=this._getLayerTreeInfo(i);if(void 0===e)continue;const a=Object.assign({},e.workingGroup);this._removeLayerTreeGroup(s,i),this._addLayerTreeItem(a,t,r)}}moveItemRelatedTo(e,t,r){var s;const i=this.getLayerTree();let a;if(this.getLayer(e))this._removeLayerTreeLayer(i,e),a=e;else{const t=this._getLayerTreeInfo(e);if(void 0===t)return;a=Object.assign({},t.workingGroup),this._removeLayerTreeGroup(i,e)}const n=y.findItemPath(i,t),o=(null!==(s=n.pop())&&void 0!==s?s:0)+(r?1:0);let h="",d=n.shift();if(void 0!==d){let e=i[d];for(;n.length&&(d=n.shift(),void 0!==d);)e=e.layers[d];h=e.name}this._addLayerTreeItem(a,h,o)}addNewLayerGroup(e,t){const r=this.getLayerTree();for(const t in e)this._removeLayerTreeLayer(r,t);this._addLayerTreeItem(t)}_removeLayerTreeLayer(e,t){for(let r=0;r<e.length;r++){const s=e[r];"string"==typeof s&&s===t?(e.splice(r,1),r--):"string"!=typeof s&&"layers"in s&&this._removeLayerTreeLayer(s.layers,t)}this.sharedModel.layerTree=e}_removeLayerTreeGroup(e,t){for(let r=0;r<e.length;r++){const s=e[r];"string"!=typeof s&&s.name===t?(e.splice(r,1),r--):"string"!=typeof s&&"layers"in s&&this._removeLayerTreeGroup(s.layers,t)}this.sharedModel.layerTree=e}renameLayerGroup(e,t){const r=this._getLayerTreeInfo(e);r?(r.workingGroup.name=t,this._sharedModel.updateLayerTreeItem(r.mainGroupIndex,r.mainGroup)):console.log("Something went wrong when renaming layer")}removeLayerGroup(e){const t=this.getLayerTree(),r=this._getLayerTreeInfo(e),s=function e(t,r){const s=[];for(const i of t)if("string"==typeof i)s.push(i);else if(i.name!==r){const t=e(i.layers,r);s.push(Object.assign(Object.assign({},i),{layers:t}))}return s}(t,e);r&&this._sharedModel.updateLayerTreeItem(r.mainGroupIndex,s[r.mainGroupIndex])}_getLayerTreeInfo(e){const t=this.getLayerTree(),r=y.findItemPath(t,e);if(!r.length)return void console.warn(`The group "${e}" does not exist in the layer tree`);const s=r.shift();if(void 0===s)return;const i=t[s];let a=i;for(;r.length;){const e=r.shift();if(void 0===e)break;a=a.layers[e]}return{mainGroup:i,workingGroup:a,mainGroupIndex:s}}}var y;!function(e){e.getOrderedLayerIds=function(e){return y.layerTreeRecursion(e.sharedModel.layerTree)}}(u||(u={})),function(e){e.layerTreeRecursion=function e(t,r=[]){for(const s of t)"string"==typeof s?r.push(s):r.push(...e(s.layers));return r},e.findItemPath=function e(t,r,s=[]){for(let i=0;i<t.length;i++){const a=t[i];if("string"==typeof a){if(a===r){const e=[...s];return e.push(i),e}}else{const t=[...s];if(t.push(i),a.name===r)return t;const n=e(a.layers,r,t);if(n.length>t.length)return n}}return s}}(y||(y={}));const p=new h.Token("jupyterGISDocTracker"),c=new h.Token("jupytergisFormSchemaRegistry"),g=new h.Token("jupytergisExternalCommandRegistry"),f=new h.Token("jupytergisExternalCommandRegistry")}}]);